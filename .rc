#!/bin/sh
# Main user profile script
# Things should be compatible with all shells (dash, bash,...)

################################
# Set load flag
export ENV_RC=$((ENV_CNT=ENV_CNT+1))

################################
# Arguments
RC_VERBOSE="true"
while getopts "vd" FLAG; do
  case "$FLAG" in
    v) RC_VERBOSE="echo";;
    *) echo >&2 "Usage: $(basename "$0") [-v]"
       echo >&2 "-v   verbose mode"
       kill -INT $$
       ;;
  esac
done; unset FLAG

################################
# List, load and reload profile scripts
alias rc='. "$HOME/.rc"'
alias load='RC_VERBOSE="echo" rc_sourcedep'
alias profile='rc'

# Load scripts by pattern and perms
rc_sourcefile() {
  # Prevent re-entrance
  [ -z "$RC_SOURCEFILE" ] || return 1
  # Preamble
  trap 'set +f; trap INT; return 1' INT # never source a file again
  set -f
  RC_SOURCEFILE=1
  # Args
  local DIR="${1:-$HOME/.rc.d}"
  local DEPTH_MIN="${2:-1}"
  local DEPTH_MAX="${3:-1}"
  local PERMS_ON="${4:--u=x}"
  local PERMS_OFF="${5}"
  command shift 5 2>/dev/null || set --
  # Main processing
  local RESULT=1
  local PATTERN="$(printf '%s\n' "${@:-*}" | sort -u)"
  for PATTERN in $PATTERN; do
    for SCRIPT in $(find "$DIR" ${DEPTH_MIN:+-mindepth $DEPTH_MIN} ${DEPTH_MAX:+-maxdepth $DEPTH_MAX} -path "*$PATTERN.sh" -not -path '*/test/*' ${PERMS_ON:+-perm $PERMS_ON} ${PERMS_OFF:+! -perm $PERMS_OFF} -prune -print | sort); do
      $RC_VERBOSE "Loading $SCRIPT"
      . "$SCRIPT" && RESULT=0 || RESULT=1
    done
  done
  # Clean up
  eval 'set +f; unset RC_SOURCEFILE; trap INT'
  # This is the end...
  return $RESULT
}

# Load executable scripts from given directory
# Declare the associated ENV_ variable
rc_sourcedir() {
  for DIR; do
    $RC_VERBOSE "Load $(basename "$DIR")/"
    local DIRNAME="$(basename "$DIR" | sed -r 's/\./_/g; s/^_//g; s/(.*)/\U\1/')"
    eval "export ENV_$DIRNAME=$((ENV_CNT=ENV_CNT+1))"
    rc_sourcefile "$DIR"
  done
}

# Load input scripts and their dependencies
rc_sourcedep() {
  $RC_VERBOSE "Load module & dependencies"
  if [ ! -z "$@" ]; then
    rc_sourcefile "$HOME/.rc.d" 1 9999 -g=r "" "$@"
  fi
  if [ ! -z "$RC_DEPENDENCIES" ]; then
    rc_sourcefile "$HOME/.rc.d" 1 9999 -g=r -u=x "$RC_DEPENDENCIES"
    unset RC_DEPENDENCIES
  fi
}

rc_list() {
  echo "List of autoloaded scripts"
  find "$HOME/.rc.d" -name '*.sh' -type f -perm -u=x -printf '%P\n'
  echo "List of non-autoloaded scripts"
  find "$HOME/.rc.d" -name '*.sh' -type f -perm -u=r ! -perm -u=x -printf '%P\n'
  echo "List of disabled scripts"
  find "$HOME/.rc.d" -name '*.sh' -type f ! -perm -u=r -printf '%P\n'
}

################################
unset RC_DEPENDENCIES

# Load .profile when not already done
if [ -z "$ENV_PROFILE" ] && [ -r "$HOME/.profile" ]; then
  $RC_VERBOSE "Load .profile"
  . "$HOME/.profile"
fi

# Load local configuration script
if [ -r "$HOME/.rc.local" ]; then
  $RC_VERBOSE "Load .rc.local"
  export ENV_RC_LOCAL=$((ENV_CNT=ENV_CNT+1))
  . "$HOME/.rc.local"
fi

# Load profile scripts
rc_sourcedir "$HOME/.rc.d"
if [ ! -z "$BASH_VERSION" ]; then
  rc_sourcedir "$HOME/.rc.d/bash"
fi
rc_sourcedir "$HOME/.rc.d/local"

# Load dependencies scripts
rc_sourcedep

################################
# Setup path
path_prepend "$HOME/bin" "$HOME/.local/bin" "$HOME/bin/profile"
path_append /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin
path_cleanup

# Remove some aliases/fct shortcuts
cmd_unset which find grep awk sed xargs cut

################################
# User anacron
if [ -r "${HOME}/.anacron/anacrontab" ]; then
  mkdir -p "${HOME}/.anacron/spool"
  anacron -s -t "${HOME}/.anacron/anacrontab" -S "${HOME}/.anacron/spool"
fi

# Start ssh-agent when not already running
pgrep -u $USER ssh-agent >/dev/null || eval $(ssh-agent)

# Disable console beep
#command -v xset >/dev/null 2>&1 && pidof X >/dev/null && xset b off 2>/dev/null # From X11 window system
command -v xset >/dev/null 2>&1 && xset b off 2>/dev/null # From X11 window system
command -v setterm >/dev/null 2>&1 && setterm -blength 0  # From the system console

################################
# Alias ls
alias l='ls -CF'
alias la='ls -A'
alias ll='ls -laF'
alias lsg='ls | grep'

# Alias cd/back
alias b='cdb'
alias f='cdf'
alias p='cd ..'

# Gvim
alias e='gvim'
alias sse='ss | cut -c 9- | xargs gvim'
alias gse='gs | grep modified | cut -d : -f 2 | xargs gvim'

# Search and open
ffe() { ff "$@" | xargs gvim; }
ffc() { ff "$@" | xargs $PAGER; }
ffg() { ff "$@" | xargs $GEDITOR; }
ffo() { ff "$@" | xargs mimeopen; }

# Gedit/geany
g() {
  eval "${GEDITOR:-false}" "$@"
}
alias ssg='ss | cut -c 9- | xargs g'
alias gsg='gs | grep modified | cut -d : -f 2 | xargs g'
ffg() {
  ff "$@" | xargs g
}

# Source insight
alias s='si'

# Alias misc
alias hi='history'
alias mo='mimeopen'

################################
# Epilogue
#Cleanup
unset RC_VERBOSE
# Set load flag
export ENV_LOADED=$ENV_CNT
export ENV_CNT
