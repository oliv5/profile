#!/bin/sh
# Main user profile script
# It should be compatible with all shells (dash, bash,...)

# Main source function
rc_source() {
  # Global variables
  export RC_DIR="${RC_DIR:-$HOME}"
  export RC_DIR_LOCAL="${RC_DIR_LOCAL:-$HOME}"

  # Local variables
  local FLAGS OPTIND OPTARG OPTERR
  local RC_VERBOSE="${RC_VERBOSE:-false}"
  local RC_DRYRUN=""

  # Global aliases
  alias rc='RC_VERBOSE=true rc_source'

  ##############
  # Log function
  rc_log() {
    ${RC_VERBOSE:-false} && echo "$@"
  }

  # Source file 
  rc_sourcefile() {
    for FILE; do
      if [ -r "$FILE" ]; then
        rc_log "Source '$FILE'"
        set --; ${RC_DRYRUN} . "$FILE"
      fi
    done
  }

  # Source module when executable or listed in rc.list 
  rc_sourcemod() {
    for FILE; do
      if test -x "$FILE" || grep -e "${FILE##*/}" "${FILE%/*}/rc.list" >/dev/null 2>&1; then
        rc_sourcefile "$FILE"
      fi
    done
  }

  ##############
  # Process arguments
  while getopts 'vdrx' FLAGS; do
    case "$FLAGS" in
      v) RC_VERBOSE="true";;
      d) RC_DRYRUN="true";;
      *) echo >&2 "Usage: .rc [-v] [-d] [-r] [-x]"
         echo >&2 "-v   verbose mode"
         echo >&2 "-d   dry-run"
         kill -INT $$
         ;;
    esac
  done
  shift $(expr $OPTIND - 1)

  ##############
  # Startup scripts
  if [ $# -eq 0 ]; then
    export ENV_RC=$((ENV_RC+1))
    rc_log "Source $RC_DIR/.rc"
    if [ -z "$ENV_PROFILE" ]; then # when not already done
      rc_sourcefile "$RC_DIR/.profile"
    fi
    rc_sourcefile "$RC_DIR_LOCAL/.rc.local"
  fi

  ##############
  # Main scripts
  for PATTERN in "${@:-*}"; do
    rc_sourcemod "$RC_DIR/.rc.d/"*$PATTERN*.sh
    if [ -n "$BASH_VERSION" ]; then
      rc_sourcemod "$RC_DIR/.rc.d/bash/"*$PATTERN*.sh
    fi
    if [ -n "$ANDROID_ROOT" ]; then
      rc_sourcemod "$RC_DIR/.rc.d/android/"*$PATTERN*.sh
    fi
    rc_sourcemod "$RC_DIR_LOCAL/.rc.local.d/"*$PATTERN*.sh
    if [ -n "$BASH_VERSION" ]; then
      rc_sourcemod "$RC_DIR_LOCAL/.rc.local.d/bash/"*$PATTERN*.sh
    fi
  done

  ##############
  # End scripts
  if [ $# -eq 0 ]; then
    rc_sourcefile "$RC_DIR/.rc.end"
    rc_sourcefile "$RC_DIR_LOCAL/.rc.local.end"
  fi

  ##############
  return 0
}

################################
# Source rc files
rc_source "$@"
