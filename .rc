#!/bin/sh
# Main user profile script
# It should be compatible with all shells (dash, bash,...)

################################
# Define global variables
export ENV_RC=$((ENV_CNT=ENV_CNT+1))
export RC_PERMS="${RC_PERMS:--x}"
export RC_DIR="${RC_DIR:-$HOME}"
# Define local variables
RC_VERBOSE="false"
RC_DRYRUN="false"

################################
# Arguments
while getopts 'vdrx' ARG; do
  case "$ARG" in
    v) RC_VERBOSE="true";;
    d) RC_DRYRUN="true";;
    r) RC_PERMS="-r";;
    x) RC_PERMS="-x";;
    *) echo >&2 "Usage: $(basename "$0") [-v]"
       echo >&2 "-v   verbose mode"
       echo >&2 "-d   dry-run"
       echo >&2 "-r   load all readable (def executable) scripts"
       kill -INT $$
       ;;
  esac
done
shift $(expr $OPTIND - 1)
# The following fails in dash 0.5.7-3
#unset OPTIND
unset ARG OPTARG OPTERR

################################
# Log function
rc_log() {
  ${RC_VERBOSE:-false} && echo "$@"
}

################################
# List, load and reload profile scripts
alias rc='. "$RC_DIR/.rc"'
alias load='RC_VERBOSE=true rc_sourcemods'
alias profile='rc'

# Source files by name and perms
rc_sourcefiles() {
  local PERM="${1:-${RC_PERMS:--x}}"
  local REGEX="^[rwx]*$(echo $PERM | sed -e 's/-//g')[rwx]*\s+"
  local VAR="${2}"
  shift 2
  # Set marker
  if [ ! -z "$VAR" ]; then
    export $VAR=$((ENV_CNT=ENV_CNT+1))
  fi
  # Source all files
  for FILE; do
    if test ${PERM} "$FILE" || grep -E "$REGEX$FILE" "$RC_DIR/.rcperms" >/dev/null 2>&1; then
      rc_log "Source $FILE"
      . "$FILE"
    fi
  done
}

# Source files by partial name
rc_sourcemods() {
  for FILE; do
    rc_sourcefiles "-r" "" "$RC_DIR/.rc.d/"*$FILE*.sh
  done
}

################################
# Source .profile when not already done
if [ -z "$ENV_PROFILE" ]; then
  rc_sourcefiles "-r" "" "$RC_DIR/.profile"
fi

# Source profile scripts in order
rc_log "Source $RC_DIR/.rc"
rc_sourcefiles "-r" "ENV_RC_LOCAL" "$RC_DIR/.rc.local"
rc_sourcefiles "$RC_PERMS" "ENV_RC_D" "$RC_DIR/.rc.d/"*.sh
if [ ! -z "$BASH_VERSION" ]; then
  rc_sourcefiles "$RC_PERMS" "ENV_RC_D_BASH" "$RC_DIR/.rc.d/bash/"*.sh
fi
rc_sourcefiles "$RC_PERMS" "ENV_RC_D_LOCAL" "$RC_DIR/.rc.d/local/"*.sh
rc_sourcefiles "-r" "ENV_RC_END" "$RC_DIR/.rc.end"
rc_sourcefiles "-r" "ENV_RC_LOCAL_END" "$RC_DIR/.rc.local.end"

################################
#Clean local variables
unset RC_VERBOSE
unset RC_DRYRUN
# Set load flag
export ENV_LOADED=$ENV_CNT
export ENV_CNT
# make sure this is the last line
# to ensure a good return code
