#!/bin/sh
# Main user profile script
# It should be compatible with all shells (dash, bash,...)

################################
# Set load flag
export ENV_RC=$((ENV_CNT=ENV_CNT+1))
# Local RC variables
RC_VERBOSE="false"
RC_DRYRUN="false"
RC_AUTOLOAD="-x"

################################
# Arguments
while getopts 'vdr' _ARG; do
  case "$_ARG" in
    v) RC_VERBOSE="true";;
    d) RC_DRYRUN="true";;
    r) RC_AUTOLOAD="-r";;
    *) echo >&2 "Usage: $(basename "$0") [-v]"
       echo >&2 "-v   verbose mode"
       echo >&2 "-d   dry-run"
       echo >&2 "-r   load all readable (def executable) scripts"
       kill -INT $$
       ;;
  esac
done
shift $(expr $OPTIND - 1)
unset _ARG

################################
# Log function
rc_log() {
  ${RC_VERBOSE:-false} && echo "$@"
}

################################
# List, load and reload profile scripts
alias rc='. "$HOME/.rc"'
alias load='RC_VERBOSE=true rc_sourcemods'
alias profile='rc'

# Source files by name and perms
rc_sourcefiles() {
  local PERM="${1:?No permissions set}"
  local VAR="${2?No marker variable set}"
  shift 2
  # Set marker
  if [ ! -z "$VAR" ]; then
    export $VAR=$((ENV_CNT=ENV_CNT+1))
  fi
  # Source all files
  for FILE; do
    if test $PERM "$FILE"; then
      rc_log "Source $FILE"
      . "$FILE"
    fi
  done
}

# Source files by partial name
rc_sourcemods() {
  for FILE; do
    rc_sourcefiles "-f" "" "$HOME/.rc.d/"*$FILE*.sh
  done
}

################################
# Source .profile when not already done
if [ -z "$ENV_PROFILE" ]; then
  rc_sourcefiles "-r" "" "$HOME/.profile"
fi

# Source profile scripts in order
rc_log "Source $HOME/.rc"
rc_sourcefiles "-r" "ENV_RC_LOCAL" "$HOME/.rc.local"
rc_sourcefiles "$RC_AUTOLOAD" "ENV_RC_D" "$HOME/.rc.d/"*.sh
if [ ! -z "$BASH_VERSION" ]; then
  rc_sourcefiles "$RC_AUTOLOAD" "ENV_RC_D_BASH" "$HOME/.rc.d/bash/"*.sh
fi
rc_sourcefiles "$RC_AUTOLOAD" "ENV_RC_D_LOCAL" "$HOME/.rc.d/local/"*.sh
rc_sourcefiles "-r" "ENV_RC_END" "$HOME/.rc.end"
rc_sourcefiles "-r" "ENV_RC_LOCAL_END" "$HOME/.rc.local.end"

################################
# Epilogue
#Cleanup
unset RC_VERBOSE
unset RC_DRYRUN
# Set load flag
export ENV_LOADED=$ENV_CNT
export ENV_CNT
