[DEFAULT]

# Add few git actions
lib =
	execute() {
		CMD="$1"; shift
		if git config --bool vcsh.vcsh >/dev/null; then
			REPO="$(basename $MR_REPO .git)"
			CMD="vcsh run $REPO"
		fi
		eval $CMD sh -c \""$@"\"
	}
	git_clone() {
		URL="$1"
		REPO=$(basename $MR_REPO .git)
		execute "" "
			git clone "$URL" $REPO
			if [ ! -z "$2" ]; then git remote rename origin $2; fi
		"
	}
	git_pull() {
		execute "" "
			git stash save -q 'mrconfig_stash'
			for REMOTE in $1; do
				if git remote | grep -- \\\$REMOTE >/dev/null; then
					for BRANCH in $2; do
						git pull --rebase \\\$REMOTE \\\$BRANCH
					done
				fi
			done
			if git stash list -n 1 | grep 'mrconfig_stash' >/dev/null 2>&1; then git stash apply -q --index; git stash drop -q; fi
		"
	}
	git_push() {
		for REMOTE in $1; do
			if git remote | grep -- $REMOTE >/dev/null; then
				for BRANCH in $2; do
					echo -n "Push $REMOTE/$BRANCH : "
					git push $REMOTE $BRANCH
				done
			fi
		done
	}
	git_bundle() {
		git bundle create "${1:-./$(basename $MR_REPO .git).bundle.$(uname -n).$(date +%Y%m%d-%H%M%S).git}" --all --tags --remotes
	}

# Define vcsh helpers
lib =
	vcsh_clone() {
		REPO=$(basename $MR_REPO .git)
		vcsh init $REPO
		git_clone "$@"
	}

# Define git annex helpers
lib =
	annex_sync() {
		execute "" "git annex sync"
	}

# Include our repositories
include = cat ${XDG_CONFIG_HOME:-$HOME/.config}/mr/config.d/*
