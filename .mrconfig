[DEFAULT]

# Add few git actions
lib =
	execute() {
		CMD="$1"
		if git config --bool vcsh.vcsh >/dev/null; then
			REPO="$(basename $MR_REPO .git)"
			CMD="vcsh run $REPO"
		fi
		eval $CMD sh -c "$2"
	}
	git_clone() {
		URL="$1"
		REPO=$(basename $MR_REPO .git)
		execute "" "\"
			git clone "$URL" $REPO
			git remote rename origin rpi
			## Not necessary
			#git branch --set-upstream-to=rpi/master master
			##Â Not used anymore
			#git remote add github https://oliv5@github.com/oliv5/$MR_REPO
		\""
	}
	git_pull() {
		execute "" "\"
			git stash save -q 'mrconfig_stash'
			git remote | grep "$1" 2>/dev/null | xargs -I{} git pull --rebase {} $2
			if git stash list -n 1 | grep 'mrconfig_stash' >/dev/null 2>&1; then git stash apply -q --index; git stash drop -q; fi
		\""
	}
	git_push() {
		git remote | grep "$1" 2>/dev/null | xargs -I{} sh -c 'echo -n "Push {}${2:+/$2} : "; git push {} $2' -a "$@"
	}
	git_bundle() {
		REPO="${1:-$(basename $MR_REPO .git)}"
		git bundle create "$HOME/repo/sync/git/bundle/$REPO.bundle.$(date +%Y%m%d-%H%M%S).git" --all --tags --remotes
	}

# Define vcsh helpers
lib =
	vcsh_clone() {
		REPO=$(basename $MR_REPO .git)
		vcsh init $REPO
		git_clone "$1"
	}

# Define git annex helpers
lib =
	annex_sync() {
		execute "" "git annex sync"
	}
	
# Our main server helpers
lib =
	git_clone_remote() {
		git_clone "ssh://olivier@oliv5kta.dtdns.net:443/home/olivier/git/$MR_REPO"
	}
	vcsh_clone_remote() {
		vcsh_clone "ssh://olivier@oliv5kta.dtdns.net:443/home/olivier/git/$MR_REPO"
	}

# Include our repositories
include = cat ${XDG_CONFIG_HOME:-$HOME/.config}/mr/config.d/*
